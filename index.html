<!--
Copyright 2026 Digital Bazaar, Inc.

SPDX-License-Identifier: BSD-3-Clause
-->

<html>
  <head>
    <meta http-equiv="content-security-policy" content="frame-src 'none'">
    <style>
      .flex-container {
        display: flex;
        /* Optional: Adds space between the items */
        gap: 20px;

        @media (width <= 1080px) {
          flex-direction: column;
        }
      }

      .column-item {
        /* Items will grow to fill equal available horizontal space */
        flex: 1;
        /* Add other styling */
        padding: 15px;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
      }

      .show {
        display: block !important;
      }

      @media (width >= 1080px) {
        .expander {
          display: none;
        }
        .expand-content {
          display: block;
        }
      }

      @media (width <= 1080px) {
        .expander {
          display: block;
        }
        .expand-content {
          display: none;
        }
      }
    </style>
    <script type="module">
      import {render} from './render.js';

      let useButton = false;

      document.addEventListener('DOMContentLoaded', () => {
        // expand interface for raw/complete VC
        const expandButton = document.querySelector('#expand-button');
        expandButton.addEventListener('click', () => {
          const content = document.querySelector('.expand-content');
          if(content.classList.contains('show')) {
            content.classList.remove('show');
            expandButton.textContent = 'Show';
          } else {
            content.classList.add('show');
            expandButton.textContent = 'Hide';
          }
        });

        const renderButton = document.querySelector('#render');
        const loading = document.querySelector('#loading');
        renderButton.addEventListener('click', () => {
          renderButton.style.display = 'none';
          loading.style.display = 'block';
          doRender().catch(() => {});
        });

        // render immediately if button=false is specified
        const searchParams = new URLSearchParams(window.location.search);
        useButton = searchParams.get('button') !== 'false';
        if(!useButton) {
          renderButton.style.display = 'none';
          doRender().catch(() => {});
        }
      });

      const credential = {
        '@context': [
          'https://www.w3.org/ns/credentials/v2',
          'https://www.w3.org/ns/credentials/examples/v2'
        ],
        type: ['VerifiableCredential', 'NameCredential'],
        issuer: {
          id: 'did:example:1234',
          name: 'The Issuer',
        },
        credentialSubject: {
          name: 'Example Name',
          notRendered: 'should not appear'
        },
        renderMethod: {
          type: 'TemplateRenderMethod',
          renderEngine: 'html',
          renderProperty: [
            '/issuer/name',
            '/credentialSubject/name'
          ],
          template: {
            id:
              'https://test.example/credential-templates/NameCredential.html',
            mediaType: 'text/html',
            digestMultibase:
              'zQmerWC85Wg6wFl9znFCwYxApG270iEu5h6JqWAPdhyxz2dR'
          },
          outputPreference: {
            mode: ['visual', 'audio'],
            mediaType: 'application/html',
            // FIXME: TBD
            style: {width: '800px', height: '800px'}
          }
        }
      };

      const fullCredentialAsString = JSON.stringify(credential, null, 2);
      const fullCredentialTextarea =
        document.querySelector('#fullCredential');
      fullCredentialTextarea.innerHTML = fullCredentialAsString;
      fullCredentialTextarea.style.width = '100%';
      fullCredentialTextarea.style.height =
        fullCredentialAsString.split('\n').length - 1 + 'rem';

      async function doRender() {
        const renderMethod = credential.renderMethod;
        // FIXME: dereference template from `renderMethod.id`
        const template = `
          <div>
            <script>
              document.addEventListener('DOMContentLoaded', () => {
                console.log('running template render script');

                // display credential as JSON as an example renderer; anything
                // could be done here instead, including mustache/other-style
                // template processing to generate the HTML for display
                const credential = JSON.parse(document.querySelector(
                  'head > script[name="credential"]').innerHTML);
                const contentDiv = document.querySelector('#content');
                console.log('contentDiv el', contentDiv);

                const credentialAsString = JSON.stringify(credential, null, 2);
                contentDiv.innerHTML = credentialAsString;
                contentDiv.style.width = '100%';
                contentDiv.style.height = credentialAsString.split('\\n').length - 1 + 'rem';

                document.querySelector('#credentialSubject-name').innerText =
                  credential.credentialSubject.name;
                document.querySelector('#issuer-name').innerText =
                  credential.issuer.name;

                // demonstrate blocked network access
                fetch('./index.html').then(result => {
                  console.error('fetch not blocked', result);
                }).catch(e => {
                  console.log('network access intentionally blocked', e);
                });
                setTimeout(() => {
                  window.renderMethodReady()
                }, ${useButton ? 2000 : 0});
              });
            <\/script>
            <h1 id="credentialSubject-name"></h1>
            <p>Issued by: <span id="issuer-name"></span></p>
            <div>
              <label for="content">Selectively Disclosed Credential:</label>
              <div><textarea id="content"></textarea></div>
            </div>
            <div>
              The outer/Wallet HTML uses
              <abbr title="Content-Security-Policy">CSP</abbr> set in its
              <code>&lt;meta&gt;</code> tag to prevent the use of an
              <code>src</code> attribute being used (i.e., "frame-src 'none'").
              Consequently, clicking the following link will result in an error
              (i.e., it won't hit the server at all):
              <ul>
                <li><a href="https://example.com/link-blocked">
                  Remote Link (should be blocked)</a>
                </li>
                <li>
                  <a href="${window.location.href}/?exfiltration=attempt">
                    Local Link (should be blocked)
                  </a>
                </li>
              </ul>
            </div>
          </div>`;

        const {iframe} = await render({
          credential,
          renderProperty: renderMethod.renderProperty,
          template,
          renderMethodReady() {
            console.log('rendering ready');
            const loading = document.querySelector('#loading');
            loading.style.display = 'none';
            iframe.style.display = 'block';
          }
        });
        const {style} = renderMethod.outputPreference;
        for(const key in style) {
          iframe.style[key] = style[key];
        }
        iframe.style.display = 'none';
        const display = document.querySelector('#display');
        display.appendChild(iframe);
      }
    </script>
  </head>
  <body>
    <h1>HTML Render Method Test</h1>
    <p>This page would live inside a Wallet (or other Verifiable Credential
      rendering client).
    </p>

    <div class="flex-container">
      <div class="column-item">
        <h2>Raw/Complete Verifiable Credential</h2>
        <div class="expander">
          <button id="expand-button">Show</button>
        </div>
        <div class="expand-content">
          <p>
            Below is the "raw" Credential data prior to being selectively disclosed
            and rendered by the iframe (to the right):
          </p>
          <textarea id="fullCredential"></textarea>
        </div>
      </div>
      <div class="column-item">
        <h2>Rendered Credential (in a restricted <code>iframe</code>)</h2>
        <p>
          Below is the rendered Credential after selective disclosure and
          rendering via the HTML Render Method within a sandboxed
          <code>iframe</code>:
        </p>

        <div id="display">
          <button id="render">
            Render
          </button>
          <div id="loading" style="display: none">
            Waiting 2 seconds to demonstrate async capability...
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

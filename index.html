<html>
  <head>
    <meta http-equiv="content-security-policy" content="frame-src 'none'">
    <script type="module">
      import {render} from './render.js';

      let useButton = false;

      document.addEventListener('DOMContentLoaded', () => {
        const button = document.querySelector('#load');

        // skip button if specified
        const searchParams = new URLSearchParams(window.location.search);
        useButton = searchParams.get('button') !== 'false';
        if(!useButton) {
          button.style.display = 'none';
          doRender().catch(() => {});
          return;
        }

        // use button interface
        const loading = document.querySelector('#loading');
        button.addEventListener('click', () => {
          button.style.display = 'none';
          loading.style.display = 'block';
          doRender().catch(() => {});
        });
      });

      async function doRender() {
        const credential = {
          '@context': [
            'https://www.w3.org/ns/credentials/v2',
            'https://www.w3.org/ns/credentials/examples/v2'
          ],
          type: ['VerifiableCredential', 'NameCredential'],
          issuer: {
            id: 'did:example:1234',
            name: 'The Issuer',
          },
          credentialSubject: {
            name: 'Example Name',
            notRendered: 'should not appear'
          },
          renderMethod: {
            type: 'TemplateRenderMethod',
            renderEngine: 'html',
            renderProperty: [
              '/issuer/name',
              '/credentialSubject/name'
            ],
            template: {
              id:
                'https://test.example/credential-templates/NameCredential.html',
              mediaType: 'text/html',
              digestMultibase:
                'zQmerWC85Wg6wFl9znFCwYxApG270iEu5h6JqWAPdhyxz2dR'
            },
            outputPreference: {
              mode: ['visual', 'audio'],
              mediaType: 'application/html',
              // FIXME: TBD
              style: {width: '800px', height: '800px'}
            }
          }
        };
        const renderMethod = credential.renderMethod;
        // FIXME: dereference template from `renderMethod.id`
        const template = `
          <div>
            <script>
              console.log('running template render script');

              // display credential as JSON as an example renderer; anything
              // could be done here instead, including mustache/other-style
              // template processing to generate the HTML for display
              const credential = JSON.parse(document.querySelector(
                'head > script[name="credential"]').innerHTML);
              document.querySelector('#content').innerHTML =
                JSON.stringify(credential, null, 2);

              // demonstrate blocked network access
              fetch('./index.html').then(result => {
                console.error('fetch not blocked', result);
              }).catch(e => {
                console.log('network access intentionally blocked', e);
              });
              setTimeout(() => {
                window.renderMethodReady()
              }, ${useButton ? 2000 : 0});
            <\/script>
            <div>
              Rendered Credential:
              <pre id="content"></pre>
            </div>
            <div>
              If top HTML csp uses "content-security-policy: frame-src 'none'"
              then this link will be blocked. See "meta" tag. This approach
              will block the request entirely, i.e., it won't hit the server
              at all.
              <a href="${window.location.href}?exfiltrate=false">
                Link blocked
              </a>
            </div>
          </div>`;

        const {iframe} = await render({
          credential,
          renderProperty: renderMethod.renderProperty,
          template,
          renderMethodReady() {
            console.log('rendering ready');
            const loading = document.querySelector('#loading');
            loading.style.display = 'none';
            iframe.style.display = 'block';
          }
        });
        const {style} = renderMethod.outputPreference;
        for(const key in style) {
          iframe.style[key] = style[key];
        }
        iframe.style.display = 'none';
        const display = document.querySelector('#display');
        display.appendChild(iframe);
      }
    </script>
  </head>
  <body>
    <div>HTML Render Method Test</div>
    <div id="display">
      <button id="load">
        Render
      </button>
      <div id="loading" style="display: none">
        Waiting 2 seconds to demonstrate async capability...
      </div>
    </div>
  </body>
</html>
